{% extends "base.html" %}
{% block title %}Settings - Library Manager{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-gear"></i> Settings</h2>
</div>

<form method="POST">
    <div class="row">
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-folder"></i> Library Paths
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Paths to Scan (one per line)</label>
                        <textarea class="form-control bg-dark text-light" name="library_paths" rows="4"
                                  placeholder="/mnt/rag_data/audiobooks">{{ config.library_paths | join('\n') }}</textarea>
                        <small class="text-muted">Full paths to your audiobook library folders</small>
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-robot"></i> AI Configuration
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">AI Provider</label>
                        <select class="form-select bg-dark text-light" name="ai_provider" id="ai_provider" onchange="toggleProviderFields()">
                            <option value="openrouter" {% if config.ai_provider == 'openrouter' %}selected{% endif %}>
                                OpenRouter (Free models available)
                            </option>
                            <option value="gemini" {% if config.ai_provider == 'gemini' %}selected{% endif %}>
                                Google Gemini (Direct API)
                            </option>
                        </select>
                    </div>

                    <!-- OpenRouter Settings -->
                    <div id="openrouter-settings">
                        <div class="mb-3">
                            <label class="form-label">OpenRouter API Key</label>
                            <input type="password" class="form-control bg-dark text-light" name="openrouter_api_key"
                                   value="{{ config.openrouter_api_key or '' }}" placeholder="sk-or-v1-...">
                            <small class="text-muted">Get free key at <a href="https://openrouter.ai" target="_blank">openrouter.ai</a></small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">OpenRouter Model</label>
                            <select class="form-select bg-dark text-light" name="openrouter_model">
                                <option value="google/gemma-3n-e4b-it:free" {% if config.openrouter_model == 'google/gemma-3n-e4b-it:free' %}selected{% endif %}>
                                    Google Gemma 3N (Free)
                                </option>
                                <option value="google/gemini-2.0-flash-exp:free" {% if config.openrouter_model == 'google/gemini-2.0-flash-exp:free' %}selected{% endif %}>
                                    Google Gemini 2.0 Flash (Free)
                                </option>
                                <option value="meta-llama/llama-3.3-70b-instruct:free" {% if config.openrouter_model == 'meta-llama/llama-3.3-70b-instruct:free' %}selected{% endif %}>
                                    Llama 3.3 70B (Free)
                                </option>
                                <option value="mistralai/devstral-2512:free" {% if config.openrouter_model == 'mistralai/devstral-2512:free' %}selected{% endif %}>
                                    Mistral Devstral (Free)
                                </option>
                            </select>
                        </div>
                    </div>

                    <!-- Gemini Settings -->
                    <div id="gemini-settings">
                        <div class="mb-3">
                            <label class="form-label">Gemini API Key</label>
                            <input type="password" class="form-control bg-dark text-light" name="gemini_api_key"
                                   value="{{ config.gemini_api_key or '' }}" placeholder="AIza...">
                            <small class="text-muted">Get at <a href="https://aistudio.google.com" target="_blank">aistudio.google.com</a> - Free tier available</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Gemini Model</label>
                            <select class="form-select bg-dark text-light" name="gemini_model">
                                <option value="gemini-2.0-flash-lite" {% if config.gemini_model == 'gemini-2.0-flash-lite' %}selected{% endif %}>
                                    Gemini 2.0 Flash Lite (Fastest, separate quota)
                                </option>
                                <option value="gemini-2.0-flash" {% if config.gemini_model == 'gemini-2.0-flash' %}selected{% endif %}>
                                    Gemini 2.0 Flash (Fast)
                                </option>
                                <option value="gemini-2.5-flash-lite" {% if config.gemini_model == 'gemini-2.5-flash-lite' %}selected{% endif %}>
                                    Gemini 2.5 Flash Lite (Newer, separate quota)
                                </option>
                                <option value="gemini-2.5-flash" {% if config.gemini_model == 'gemini-2.5-flash' %}selected{% endif %}>
                                    Gemini 2.5 Flash (Newer)
                                </option>
                                <option value="gemini-2.5-pro" {% if config.gemini_model == 'gemini-2.5-pro' %}selected{% endif %}>
                                    Gemini 2.5 Pro (Best quality)
                                </option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-clock"></i> Scheduling
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Scan Interval (hours)</label>
                        <input type="number" class="form-control bg-dark text-light" name="scan_interval_hours"
                               value="{{ config.scan_interval_hours }}" min="1" max="168">
                        <small class="text-muted">How often to scan for new/changed books</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Batch Size</label>
                        <input type="number" class="form-control bg-dark text-light" name="batch_size"
                               value="{{ config.batch_size }}" min="1" max="10">
                        <small class="text-muted">Books per AI request</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Max API Calls Per Hour</label>
                        <input type="number" class="form-control bg-dark text-light" name="max_requests_per_hour"
                               value="{{ config.max_requests_per_hour }}" min="1" max="100">
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-toggles"></i> Behavior
                </div>
                <div class="card-body">
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" name="enabled" id="enabled"
                               {% if config.enabled %}checked{% endif %}>
                        <label class="form-check-label" for="enabled">
                            <strong>Enable Background Processing</strong><br>
                            <small class="text-muted">Automatically scan and queue suspicious books</small>
                        </label>
                    </div>
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" name="auto_fix" id="auto_fix"
                               {% if config.auto_fix %}checked{% endif %} onchange="warnAutoFix(this)">
                        <label class="form-check-label" for="auto_fix">
                            <strong>Auto-Fix Mode</strong> <span class="badge bg-warning text-dark">Caution</span><br>
                            <small class="text-muted">Automatically rename folders without approval</small><br>
                            <small class="text-danger"><i class="bi bi-exclamation-triangle"></i> This will modify your library files directly!</small>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
        <button type="submit" class="btn btn-primary btn-lg">
            <i class="bi bi-save"></i> Save Settings
        </button>
    </div>
</form>

<div class="card mt-4">
    <div class="card-header">
        <i class="bi bi-terminal"></i> Recent Logs
        <button class="btn btn-sm btn-outline-secondary float-end" onclick="refreshLogs()">
            <i class="bi bi-arrow-clockwise"></i> Refresh
        </button>
    </div>
    <div class="card-body bg-dark p-2" style="max-height: 300px; overflow-y: auto;">
        <pre id="log-output" class="mb-0 text-light" style="font-size: 0.8rem; white-space: pre-wrap;">Loading logs...</pre>
    </div>
</div>

<div class="card mt-4">
    <div class="card-header">
        <i class="bi bi-bug"></i> Bug Report
    </div>
    <div class="card-body">
        <p class="text-muted mb-3">Having issues? Generate a bug report to share with the developer.</p>
        <button class="btn btn-outline-primary" onclick="generateBugReport()">
            <i class="bi bi-clipboard"></i> Generate Bug Report
        </button>
        <a href="https://github.com/deucebucket/library-manager/issues/new" target="_blank" class="btn btn-outline-secondary ms-2">
            <i class="bi bi-github"></i> Open GitHub Issue
        </a>
        <div id="bug-report-output" class="mt-3 d-none">
            <label class="form-label">Copy this to your GitHub issue:</label>
            <textarea class="form-control bg-dark text-light" id="bug-report-text" rows="10" readonly></textarea>
            <button class="btn btn-sm btn-success mt-2" onclick="copyBugReport()">
                <i class="bi bi-clipboard-check"></i> Copy to Clipboard
            </button>
        </div>
    </div>
</div>

<div class="card mt-4">
    <div class="card-header text-danger">
        <i class="bi bi-exclamation-triangle"></i> Danger Zone
    </div>
    <div class="card-body">
        <button class="btn btn-outline-danger" onclick="clearHistory()">
            <i class="bi bi-trash"></i> Clear History
        </button>
        <button class="btn btn-outline-danger ms-2" onclick="resetDatabase()">
            <i class="bi bi-arrow-counterclockwise"></i> Reset Database
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Toggle provider settings visibility
function toggleProviderFields() {
    const provider = document.getElementById('ai_provider').value;
    document.getElementById('openrouter-settings').style.display = provider === 'openrouter' ? 'block' : 'none';
    document.getElementById('gemini-settings').style.display = provider === 'gemini' ? 'block' : 'none';
}

// Run on page load
document.addEventListener('DOMContentLoaded', function() {
    toggleProviderFields();
    refreshLogs();
});

// Convert UTC timestamp to local time
function convertToLocalTime(line) {
    // Match timestamp pattern: 2025-12-10 02:34:00,927
    const match = line.match(/^(\d{4}-\d{2}-\d{2}) (\d{2}:\d{2}:\d{2}),(\d+)/);
    if (match) {
        const utcDate = new Date(match[1] + 'T' + match[2] + 'Z');
        const localTime = utcDate.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true});
        return line.replace(match[0], localTime);
    }
    return line;
}

// Fetch and display logs
function refreshLogs() {
    fetch('/api/logs')
        .then(r => r.json())
        .then(data => {
            const logEl = document.getElementById('log-output');
            if (data.logs && data.logs.length > 0) {
                // Color-code log lines and convert to local time
                let html = data.logs.map(line => {
                    line = convertToLocalTime(line);
                    if (line.includes('ERROR')) {
                        return `<span class="text-danger">${escapeHtml(line)}</span>`;
                    } else if (line.includes('WARNING')) {
                        return `<span class="text-warning">${escapeHtml(line)}</span>`;
                    } else if (line.includes('INFO')) {
                        return `<span class="text-info">${escapeHtml(line)}</span>`;
                    }
                    return escapeHtml(line);
                }).join('\n');
                logEl.innerHTML = html;
            } else {
                logEl.textContent = 'No recent logs';
            }
            // Scroll to bottom
            logEl.parentElement.scrollTop = logEl.parentElement.scrollHeight;
        })
        .catch(e => {
            document.getElementById('log-output').textContent = 'Error loading logs: ' + e;
        });
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function clearHistory() {
    if (!confirm('Are you sure you want to clear all history? This cannot be undone.')) return;
    fetch('/api/clear_history', {method: 'POST'})
        .then(r => r.json())
        .then(data => {
            alert(data.message || 'History cleared');
            location.reload();
        });
}

function resetDatabase() {
    if (!confirm('Are you sure you want to reset the entire database? All data will be lost!')) return;
    if (!confirm('REALLY? This will delete everything!')) return;
    fetch('/api/reset_database', {method: 'POST'})
        .then(r => r.json())
        .then(data => {
            alert(data.message || 'Database reset');
            location.reload();
        });
}

// Auto-refresh logs every 10 seconds
setInterval(refreshLogs, 10000);

// Warn when enabling auto-fix
function warnAutoFix(checkbox) {
    if (checkbox.checked) {
        const confirmed = confirm(
            '⚠️ AUTO-FIX MODE WARNING ⚠️\n\n' +
            'This will AUTOMATICALLY rename folders in your library without asking for approval.\n\n' +
            'Make sure you have a backup before enabling this!\n\n' +
            'Are you sure you want to enable auto-fix?'
        );
        if (!confirmed) {
            checkbox.checked = false;
        }
    }
}

// Generate bug report
function generateBugReport() {
    fetch('/api/bug_report')
        .then(r => r.json())
        .then(data => {
            document.getElementById('bug-report-output').classList.remove('d-none');
            document.getElementById('bug-report-text').value = data.report;
        })
        .catch(e => alert('Error generating report: ' + e));
}

function copyBugReport() {
    const textarea = document.getElementById('bug-report-text');
    textarea.select();
    document.execCommand('copy');
    alert('Bug report copied to clipboard!');
}
</script>
{% endblock %}
