{% extends "base.html" %}
{% block title %}Settings - Library Manager{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2><i class="bi bi-gear"></i> Settings</h2>
    <span class="text-muted">v{{ version }}</span>
</div>

<!-- Quick Tutorial -->
<div class="alert alert-info alert-dismissible fade show mb-4" role="alert">
    <h5 class="alert-heading"><i class="bi bi-lightbulb"></i> How It Works</h5>
    <hr>
    <div class="row">
        <div class="col-md-4">
            <strong>1. Scan</strong><br>
            <small>Finds audiobook folders with messy names like:<br>
            <code>Unknown/Mistborn Book 1</code></small>
        </div>
        <div class="col-md-4">
            <strong>2. Lookup & Verify</strong><br>
            <small>Searches 4 book databases + AI to find correct metadata with smart verification</small>
        </div>
        <div class="col-md-4">
            <strong>3. Fix</strong><br>
            <small>Renames to clean format:<br>
            <code>Brandon Sanderson/The Final Empire</code></small>
        </div>
    </div>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>

<!-- Main Settings Form -->
<form method="POST" id="settings-form">
    <!-- Nav Tabs -->
    <ul class="nav nav-tabs mb-3" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-general" type="button">
                <i class="bi bi-sliders"></i> General
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-ai" type="button">
                <i class="bi bi-robot"></i> AI Setup
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-advanced" type="button">
                <i class="bi bi-gear-wide-connected"></i> Advanced
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content">
        <!-- General Tab -->
        <div class="tab-pane fade show active" id="tab-general">
            <div class="row">
                <div class="col-lg-6">
                    <!-- Library Settings -->
                    <div class="card mb-3">
                        <div class="card-header py-2">
                            <i class="bi bi-folder"></i> Library
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Library Paths <small class="text-muted">(one per line)</small></label>
                                <textarea class="form-control bg-dark text-light" name="library_paths" id="library_paths" rows="2"
                                          placeholder="/mnt/audiobooks">{{ config.library_paths | join('\n') }}</textarea>
                                <div class="mt-2">
                                    <button type="button" class="btn btn-sm btn-outline-info" onclick="testLibraryPaths()">
                                        <i class="bi bi-folder-check"></i> Test Paths
                                    </button>
                                    <small class="text-muted ms-2">Check if paths are accessible (helps debug Docker mount issues)</small>
                                </div>
                                <div id="path-test-results" class="mt-2" style="display: none;"></div>
                            </div>
                            <div class="mb-2">
                                <label class="form-label">Folder Naming Format</label>
                                <select class="form-select bg-dark text-light" name="naming_format" id="naming_format" onchange="toggleCustomNaming()">
                                    <option value="author/title" {% if config.naming_format == 'author/title' or (not config.naming_format and not config.custom_naming_template) %}selected{% endif %}>
                                        Author/Title - Audiobookshelf, Plex, Jellyfin
                                    </option>
                                    <option value="author - title" {% if config.naming_format == 'author - title' %}selected{% endif %}>
                                        Author - Title (flat) - Booksonic, basic players
                                    </option>
                                    <option value="custom" {% if config.naming_format == 'custom' %}selected{% endif %}>
                                        Custom Template - Build your own
                                    </option>
                                </select>
                            </div>

                            <!-- Custom Naming Template Builder -->
                            <div id="custom-naming-builder" class="mt-3" style="display: none;">
                                <label class="form-label">Custom Naming Template</label>
                                <div class="input-group mb-2">
                                    <input type="text" class="form-control bg-dark text-light font-monospace"
                                           name="custom_naming_template" id="custom_naming_template"
                                           value="{{ config.custom_naming_template or '{author}/{title}' }}"
                                           placeholder="{author}/{title}"
                                           oninput="updateNamingPreview()">
                                    <button type="button" class="btn btn-outline-secondary" onclick="clearNamingTemplate()">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </div>

                                <div class="mb-2">
                                    <small class="text-muted d-block mb-1">Click tags to add them:</small>
                                    <div class="d-flex flex-wrap gap-1">
                                        <button type="button" class="btn btn-sm btn-outline-info naming-tag" onclick="insertTag('{author}')">
                                            {author}
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-info naming-tag" onclick="insertTag('{title}')">
                                            {title}
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-warning naming-tag" onclick="insertTag('{series}')">
                                            {series}
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-warning naming-tag" onclick="insertTag('{series_num}')">
                                            {series_num}
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-success naming-tag" onclick="insertTag('{narrator}')">
                                            {narrator}
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary naming-tag" onclick="insertTag('{year}')">
                                            {year}
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary naming-tag" onclick="insertTag('{edition}')">
                                            {edition}
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary naming-tag" onclick="insertTag('{variant}')">
                                            {variant}
                                        </button>
                                    </div>
                                </div>

                                <div class="mb-2">
                                    <small class="text-muted d-block mb-1">Quick separators:</small>
                                    <div class="d-flex flex-wrap gap-1">
                                        <button type="button" class="btn btn-sm btn-outline-light" onclick="insertTag('/')">
                                            /
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-light" onclick="insertTag(' - ')">
                                            -
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-light" onclick="insertTag(' ')">
                                            space
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-light" onclick="insertTag('(')">
                                            (
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-light" onclick="insertTag(')')">
                                            )
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-light" onclick="insertTag('[')">
                                            [
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-light" onclick="insertTag(']')">
                                            ]
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-light" onclick="insertTag('{')">
                                            {
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-light" onclick="insertTag('}')">
                                            }
                                        </button>
                                    </div>
                                </div>

                                <div class="alert alert-dark small py-2 mb-0" id="naming-preview">
                                    <strong>Preview:</strong> <code id="preview-output">Brandon Sanderson/The Final Empire</code>
                                </div>

                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="bi bi-info-circle"></i>
                                        Tags in <span class="text-warning">yellow</span> require series info.
                                        Missing data will be omitted. Use <code>/</code> for folder separation.
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Behavior -->
                    <div class="card mb-3">
                        <div class="card-header py-2">
                            <i class="bi bi-toggles"></i> Behavior
                        </div>
                        <div class="card-body">
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" name="enabled" id="enabled"
                                       {% if config.enabled %}checked{% endif %}>
                                <label class="form-check-label" for="enabled">
                                    <strong>Enable Background Processing</strong>
                                </label>
                            </div>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" name="auto_fix" id="auto_fix"
                                       {% if config.auto_fix %}checked{% endif %} onchange="warnAutoFix(this)">
                                <label class="form-check-label" for="auto_fix">
                                    <strong>Auto-Fix Mode</strong>
                                    <span class="badge bg-warning text-dark">Caution</span>
                                    <br><small class="text-muted">Rename folders automatically without approval</small>
                                </label>
                            </div>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" name="protect_author_changes" id="protect_author_changes"
                                       {% if config.protect_author_changes %}checked{% endif %}>
                                <label class="form-check-label" for="protect_author_changes">
                                    <strong>Smart Verification</strong>
                                    <span class="badge bg-success">Recommended</span>
                                    <br><small class="text-muted">Extra verification when author changes completely</small>
                                </label>
                            </div>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" name="series_grouping" id="series_grouping"
                                       {% if config.series_grouping %}checked{% endif %}>
                                <label class="form-check-label" for="series_grouping">
                                    <strong>Series Grouping</strong>
                                    <span class="badge bg-info">BETA</span>
                                    <br><small class="text-muted">Group series books: <code>Author/Series/1 - Title</code></small>
                                </label>
                            </div>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" name="ebook_management" id="ebook_management"
                                       {% if config.ebook_management %}checked{% endif %} onchange="toggleEbookOptions()">
                                <label class="form-check-label" for="ebook_management">
                                    <strong>Ebook Management</strong>
                                    <span class="badge bg-info">BETA</span>
                                    <br><small class="text-muted">Organize ebooks (.epub, .mobi, .azw3, .pdf)</small>
                                </label>
                            </div>
                            <div id="ebook-options" class="ms-4 mb-2" style="display: none;">
                                <label class="form-label small">Ebook Library Mode</label>
                                <select class="form-select form-select-sm bg-dark text-light" name="ebook_library_mode" style="max-width: 250px;">
                                    <option value="merge" {% if config.ebook_library_mode == 'merge' %}selected{% endif %}>
                                        Merge with Audiobooks (ABS)
                                    </option>
                                    <option value="separate" {% if config.ebook_library_mode == 'separate' %}selected{% endif %}>
                                        Separate Ebook Library
                                    </option>
                                </select>
                                <small class="text-muted d-block mt-1">Merge: puts ebook in same Author/Title/ folder as audiobook</small>
                            </div>
                            <div class="form-check form-switch mb-2 mt-3">
                                <input class="form-check-input" type="checkbox" name="audio_analysis" id="audio_analysis"
                                       {% if config.audio_analysis %}checked{% endif %}>
                                <label class="form-check-label" for="audio_analysis">
                                    <strong>Audio Analysis</strong>
                                    <span class="badge bg-info">BETA</span>
                                    <br><small class="text-muted">Use Gemini to analyze audiobook intros for author/title (requires Gemini API key)</small>
                                </label>
                            </div>
                            <hr class="my-2">
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" name="metadata_embedding_enabled" id="metadata_embedding_enabled"
                                       {% if config.metadata_embedding_enabled %}checked{% endif %} onchange="toggleEmbeddingOptions()">
                                <label class="form-check-label" for="metadata_embedding_enabled">
                                    <strong>Metadata Embedding</strong>
                                    <span class="badge bg-info">BETA</span>
                                    <br><small class="text-muted">Write metadata tags into audio files when fixes are applied</small>
                                </label>
                            </div>
                            <div id="embedding-options" class="ms-4 mb-2" style="display: {% if config.metadata_embedding_enabled %}block{% else %}none{% endif %};">
                                <div class="form-check form-switch mb-2">
                                    <input class="form-check-input" type="checkbox" name="metadata_embedding_overwrite_managed" id="metadata_embedding_overwrite_managed"
                                           {% if config.metadata_embedding_overwrite_managed %}checked{% endif %}>
                                    <label class="form-check-label small" for="metadata_embedding_overwrite_managed">
                                        Overwrite existing tags (title/author/series/narrator/year)
                                    </label>
                                </div>
                                <div class="form-check form-switch mb-2">
                                    <input class="form-check-input" type="checkbox" name="metadata_embedding_backup_sidecar" id="metadata_embedding_backup_sidecar"
                                           {% if config.metadata_embedding_backup_sidecar %}checked{% endif %}>
                                    <label class="form-check-label small" for="metadata_embedding_backup_sidecar">
                                        Create backup before modifying tags
                                        <br><small class="text-muted">Saves original tags to <code>.library-manager.tags.json</code></small>
                                    </label>
                                </div>
                                <small class="text-muted">
                                    <i class="bi bi-info-circle"></i>
                                    Supports MP3, M4B/M4A, FLAC, Ogg/Opus, and WMA formats.
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6">
                    <!-- Processing -->
                    <div class="card mb-3">
                        <div class="card-header py-2">
                            <i class="bi bi-speedometer2"></i> Processing
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-6 mb-2">
                                    <label class="form-label">Scan Interval</label>
                                    <div class="input-group input-group-sm">
                                        <input type="number" class="form-control bg-dark text-light" name="scan_interval_hours"
                                               value="{{ config.scan_interval_hours }}" min="1" max="168">
                                        <span class="input-group-text bg-dark text-light">hours</span>
                                    </div>
                                </div>
                                <div class="col-6 mb-2">
                                    <label class="form-label">Batch Size</label>
                                    <input type="number" class="form-control form-control-sm bg-dark text-light" name="batch_size"
                                           value="{{ config.batch_size }}" min="1" max="10">
                                </div>
                            </div>
                            <div class="mb-0">
                                <label class="form-label">Max API Calls/Hour</label>
                                <input type="number" class="form-control form-control-sm bg-dark text-light" name="max_requests_per_hour"
                                       value="{{ config.max_requests_per_hour }}" min="1" max="500" style="max-width: 120px;">
                            </div>
                        </div>
                    </div>

                    <!-- Updates -->
                    <div class="card mb-3">
                        <div class="card-header py-2">
                            <i class="bi bi-arrow-repeat"></i> Updates
                        </div>
                        <div class="card-body py-2">
                            <div class="d-flex align-items-center gap-2">
                                <select class="form-select form-select-sm bg-dark text-light" name="update_channel" style="max-width: 180px;">
                                    <option value="stable" {% if config.update_channel == 'stable' %}selected{% endif %}>Stable</option>
                                    <option value="beta" {% if config.update_channel == 'beta' %}selected{% endif %}>Beta</option>
                                    <option value="nightly" {% if config.update_channel == 'nightly' %}selected{% endif %}>Nightly</option>
                                </select>
                                <button type="button" class="btn btn-sm btn-outline-info" onclick="checkUpdateNow()">
                                    <i class="bi bi-arrow-clockwise"></i> Check
                                </button>
                                <span id="update-status"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Setup Tab -->
        <div class="tab-pane fade" id="tab-ai">
            <div class="row">
                <div class="col-lg-6">
                    <div class="card mb-3">
                        <div class="card-header py-2">
                            <i class="bi bi-robot"></i> AI Provider
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <select class="form-select bg-dark text-light" name="ai_provider" id="ai_provider" onchange="toggleProviderFields()">
                                    <option value="gemini" {% if config.ai_provider == 'gemini' %}selected{% endif %}>
                                        Google Gemini (Recommended - 14,400 free calls/day)
                                    </option>
                                    <option value="openrouter" {% if config.ai_provider == 'openrouter' %}selected{% endif %}>
                                        OpenRouter (Free models available)
                                    </option>
                                </select>
                            </div>

                            <!-- Gemini Settings -->
                            <div id="gemini-settings">
                                <div class="mb-3">
                                    <label class="form-label">Gemini API Key</label>
                                    <input type="password" class="form-control bg-dark text-light" name="gemini_api_key"
                                           value="{{ config.gemini_api_key or '' }}" placeholder="AIza...">
                                    <small class="text-muted">Free at <a href="https://aistudio.google.com" target="_blank">aistudio.google.com</a></small>
                                </div>
                                <div class="mb-0">
                                    <label class="form-label">Model</label>
                                    <select class="form-select bg-dark text-light" name="gemini_model">
                                        <option value="gemma-3-27b-it" {% if config.gemini_model == 'gemma-3-27b-it' %}selected{% endif %}>
                                            Gemma 3 27B (Best - 14,400/day)
                                        </option>
                                        <option value="gemma-3-12b-it" {% if config.gemini_model == 'gemma-3-12b-it' %}selected{% endif %}>
                                            Gemma 3 12B (Faster)
                                        </option>
                                        <option value="gemini-2.0-flash" {% if config.gemini_model == 'gemini-2.0-flash' %}selected{% endif %}>
                                            Gemini 2.0 Flash (Lower quota)
                                        </option>
                                    </select>
                                </div>
                            </div>

                            <!-- OpenRouter Settings -->
                            <div id="openrouter-settings" style="display: none;">
                                <div class="mb-3">
                                    <label class="form-label">OpenRouter API Key</label>
                                    <input type="password" class="form-control bg-dark text-light" name="openrouter_api_key"
                                           value="{{ config.openrouter_api_key or '' }}" placeholder="sk-or-v1-...">
                                    <small class="text-muted">Get at <a href="https://openrouter.ai" target="_blank">openrouter.ai</a></small>
                                </div>
                                <div class="mb-0">
                                    <label class="form-label">Model</label>
                                    <select class="form-select bg-dark text-light" name="openrouter_model">
                                        <option value="google/gemma-3n-e4b-it:free" {% if config.openrouter_model == 'google/gemma-3n-e4b-it:free' %}selected{% endif %}>
                                            Google Gemma 3N (Free)
                                        </option>
                                        <option value="meta-llama/llama-3.3-70b-instruct:free" {% if config.openrouter_model == 'meta-llama/llama-3.3-70b-instruct:free' %}selected{% endif %}>
                                            Llama 3.3 70B (Free)
                                        </option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6">
                    <div class="card mb-3">
                        <div class="card-header py-2">
                            <i class="bi bi-cloud-download"></i> Book Metadata Sources
                        </div>
                        <div class="card-body">
                            <p class="text-muted small mb-2">Searches these APIs in order (all free, no setup needed):</p>
                            <ol class="small mb-3">
                                <li><strong>Audnexus</strong> - Audiobooks (from Audible)</li>
                                <li><strong>OpenLibrary</strong> - General books</li>
                                <li><strong>Google Books</strong> - Wide coverage</li>
                                <li><strong>Hardcover</strong> - Indie/modern books</li>
                                <li><strong>AI Fallback</strong> - When APIs fail</li>
                            </ol>
                            <div class="mb-0">
                                <label class="form-label small">Google Books API Key <span class="text-muted">(optional)</span></label>
                                <input type="password" class="form-control form-control-sm bg-dark text-light" name="google_books_api_key"
                                       value="{{ config.google_books_api_key or '' }}" placeholder="For higher rate limits">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Advanced Tab -->
        <div class="tab-pane fade" id="tab-advanced">
            <div class="row">
                <div class="col-lg-6">
                    <!-- Danger Zone -->
                    <div class="card mb-3 border-danger">
                        <div class="card-header py-2 text-danger">
                            <i class="bi bi-exclamation-triangle"></i> Danger Zone
                        </div>
                        <div class="card-body">
                            <p class="text-muted small mb-2">Use with caution. These actions cannot be undone.</p>
                            <div class="d-flex gap-2 flex-wrap">
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearHistory()">
                                    <i class="bi bi-trash"></i> Clear History
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="resetDatabase()">
                                    <i class="bi bi-arrow-counterclockwise"></i> Reset Database
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Bug Report -->
                    <div class="card mb-3">
                        <div class="card-header py-2">
                            <i class="bi bi-bug"></i> Bug Report
                        </div>
                        <div class="card-body py-2">
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="generateBugReport()">
                                    <i class="bi bi-clipboard"></i> Generate Report
                                </button>
                                <a href="https://github.com/deucebucket/library-manager/issues/new" target="_blank" class="btn btn-sm btn-outline-secondary">
                                    <i class="bi bi-github"></i> GitHub Issues
                                </a>
                            </div>
                            <div id="bug-report-output" class="mt-2 d-none">
                                <textarea class="form-control form-control-sm bg-dark text-light" id="bug-report-text" rows="6" readonly></textarea>
                                <button type="button" class="btn btn-sm btn-success mt-1" onclick="copyBugReport()">
                                    <i class="bi bi-clipboard-check"></i> Copy
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6">
                    <!-- Backup & Restore -->
                    <div class="card mb-3 border-info">
                        <div class="card-header py-2 text-info">
                            <i class="bi bi-cloud-arrow-down"></i> Backup & Restore
                        </div>
                        <div class="card-body">
                            <p class="text-muted small mb-3">Backup your settings, groups, and database. Restore on a new installation or after a reset.</p>

                            <div class="d-flex gap-2 flex-wrap mb-3">
                                <a href="/api/backup" class="btn btn-sm btn-outline-info" id="backup-btn">
                                    <i class="bi bi-download"></i> Download Backup
                                </a>
                                <button type="button" class="btn btn-sm btn-outline-warning" onclick="showRestoreModal()">
                                    <i class="bi bi-upload"></i> Restore Backup
                                </button>
                            </div>

                            <div id="backup-info" class="small text-muted">
                                <i class="bi bi-hourglass-split"></i> Loading backup info...
                            </div>
                        </div>
                    </div>

                    <!-- Recent Logs -->
                    <div class="card mb-3">
                        <div class="card-header py-2">
                            <i class="bi bi-terminal"></i> Recent Logs
                            <button type="button" class="btn btn-sm btn-outline-secondary float-end py-0" onclick="refreshLogs()">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </div>
                        <div class="card-body bg-dark p-2" style="max-height: 400px; overflow-y: auto;">
                            <pre id="log-output" class="mb-0 text-light" style="font-size: 0.7rem; white-space: pre-wrap;">Loading...</pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Save Button (sticky) -->
    <div class="position-sticky bottom-0 bg-dark py-3 border-top mt-3" style="z-index: 100;">
        <div class="d-flex justify-content-end">
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-save"></i> Save Settings
            </button>
        </div>
    </div>
</form>

<!-- Restore Modal -->
<div class="modal fade" id="restoreModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-upload"></i> Restore Backup</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning small">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Warning:</strong> Restoring will overwrite your current settings, groups, and database.
                    A backup of your current state will be saved first.
                </div>

                <form id="restore-form" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label class="form-label">Select Backup File</label>
                        <input type="file" class="form-control bg-dark text-light" name="backup" accept=".zip" required>
                        <small class="text-muted">Upload a .zip backup file created by this app</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="restoreBackup()">
                    <i class="bi bi-upload"></i> Restore
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function toggleProviderFields() {
    const provider = document.getElementById('ai_provider').value;
    document.getElementById('openrouter-settings').style.display = provider === 'openrouter' ? 'block' : 'none';
    document.getElementById('gemini-settings').style.display = provider === 'gemini' ? 'block' : 'none';
}

function toggleEbookOptions() {
    const enabled = document.getElementById('ebook_management').checked;
    document.getElementById('ebook-options').style.display = enabled ? 'block' : 'none';
}

function toggleEmbeddingOptions() {
    const enabled = document.getElementById('metadata_embedding_enabled').checked;
    document.getElementById('embedding-options').style.display = enabled ? 'block' : 'none';
}

document.addEventListener('DOMContentLoaded', function() {
    toggleProviderFields();
    toggleCustomNaming();
    toggleEbookOptions();
    updateNamingPreview();
    refreshLogs();
});

// Custom Naming Template Builder
const sampleData = {
    author: 'Brandon Sanderson',
    title: 'The Final Empire',
    series: 'Mistborn',
    series_num: '1',
    narrator: 'Michael Kramer',
    year: '2006',
    edition: 'First Edition',
    variant: ''
};

function toggleCustomNaming() {
    const format = document.getElementById('naming_format').value;
    const builder = document.getElementById('custom-naming-builder');
    if (builder) {
        builder.style.display = format === 'custom' ? 'block' : 'none';
        if (format === 'custom') {
            updateNamingPreview();
        }
    }
}

function insertTag(tag) {
    const input = document.getElementById('custom_naming_template');
    const start = input.selectionStart;
    const end = input.selectionEnd;
    const text = input.value;
    input.value = text.substring(0, start) + tag + text.substring(end);
    input.focus();
    input.setSelectionRange(start + tag.length, start + tag.length);
    updateNamingPreview();
}

function clearNamingTemplate() {
    document.getElementById('custom_naming_template').value = '';
    updateNamingPreview();
}

function updateNamingPreview() {
    const template = document.getElementById('custom_naming_template').value || '{author}/{title}';
    let preview = template;

    // Replace tags with sample data
    Object.keys(sampleData).forEach(key => {
        const regex = new RegExp(`\\{${key}\\}`, 'g');
        preview = preview.replace(regex, sampleData[key] || '');
    });

    // Clean up empty brackets/parens from missing optional data
    preview = preview.replace(/\(\s*\)/g, '');
    preview = preview.replace(/\[\s*\]/g, '');
    preview = preview.replace(/\{\s*\}/g, '');
    preview = preview.replace(/\s+-\s+(?=-|\/|$)/g, '');  // Dangling " - " before separator
    preview = preview.replace(/\/-\s+/g, '/');  // Leading "- " after slash
    preview = preview.replace(/^-\s+/, '');  // Leading "- " at start
    preview = preview.replace(/\s+-$/, '');  // Trailing " -" at end
    preview = preview.replace(/\/+/g, '/');
    preview = preview.replace(/\s{2,}/g, ' ');
    preview = preview.trim();

    document.getElementById('preview-output').textContent = preview || '(empty)';
}

function refreshLogs() {
    fetch('/api/logs').then(r => r.json()).then(data => {
        const logEl = document.getElementById('log-output');
        if (data.logs && data.logs.length > 0) {
            let html = data.logs.map(line => {
                if (line.includes('ERROR')) return `<span class="text-danger">${escapeHtml(line)}</span>`;
                if (line.includes('WARNING')) return `<span class="text-warning">${escapeHtml(line)}</span>`;
                if (line.includes('VERIFIED') || line.includes('Fixed:')) return `<span class="text-success">${escapeHtml(line)}</span>`;
                return escapeHtml(line);
            }).join('\n');
            logEl.innerHTML = html;
            logEl.parentElement.scrollTop = logEl.parentElement.scrollHeight;
        } else {
            logEl.textContent = 'No recent logs';
        }
    }).catch(e => { document.getElementById('log-output').textContent = 'Error: ' + e; });
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function warnAutoFix(checkbox) {
    if (checkbox.checked && !confirm('Auto-Fix will rename folders automatically. Make sure you have backups!\n\nEnable?')) {
        checkbox.checked = false;
    }
}

function checkUpdateNow() {
    const el = document.getElementById('update-status');
    el.innerHTML = '<span class="text-info small"><i class="bi bi-hourglass-split"></i></span>';
    fetch('/api/check_update').then(r => r.json()).then(data => {
        if (data.update_available) {
            el.innerHTML = `<a href="${data.release_url}" target="_blank" class="btn btn-sm btn-success py-0">${data.latest}</a>`;
        } else {
            el.innerHTML = '<span class="text-success small"><i class="bi bi-check"></i></span>';
        }
    }).catch(() => { el.innerHTML = '<span class="text-danger small"><i class="bi bi-x"></i></span>'; });
}

function clearHistory() {
    if (!confirm('Clear all history? Cannot be undone.')) return;
    fetch('/api/clear_history', {method: 'POST'}).then(() => location.reload());
}

function resetDatabase() {
    if (!confirm('Reset ENTIRE database? All data will be lost!')) return;
    if (!confirm('REALLY sure?')) return;
    fetch('/api/reset_database', {method: 'POST'}).then(() => location.reload());
}

function generateBugReport() {
    fetch('/api/bug_report').then(r => r.json()).then(data => {
        document.getElementById('bug-report-output').classList.remove('d-none');
        document.getElementById('bug-report-text').value = data.report;
    });
}

function copyBugReport() {
    document.getElementById('bug-report-text').select();
    document.execCommand('copy');
    alert('Copied!');
}

setInterval(refreshLogs, 10000);

// Backup & Restore functions
let restoreModal = null;

function loadBackupInfo() {
    fetch('/api/backup/info')
        .then(r => r.json())
        .then(data => {
            const el = document.getElementById('backup-info');
            if (data.files && data.files.length > 0) {
                let html = `<strong>Backup includes:</strong><ul class="mb-0 ps-3">`;
                data.files.forEach(f => {
                    html += `<li>${f.name} (${f.size_human})</li>`;
                });
                html += `</ul><div class="mt-1">Total: ${data.total_size_human}</div>`;
                el.innerHTML = html;
            } else {
                el.innerHTML = 'No files to backup';
            }
        })
        .catch(e => {
            document.getElementById('backup-info').innerHTML = '<span class="text-danger">Error loading info</span>';
        });
}

function showRestoreModal() {
    if (!restoreModal) {
        restoreModal = new bootstrap.Modal(document.getElementById('restoreModal'));
    }
    restoreModal.show();
}

function restoreBackup() {
    const form = document.getElementById('restore-form');
    const fileInput = form.querySelector('input[name="backup"]');

    if (!fileInput.files || fileInput.files.length === 0) {
        alert('Please select a backup file');
        return;
    }

    if (!confirm('Restore from this backup? Your current settings will be backed up first.')) {
        return;
    }

    const formData = new FormData();
    formData.append('backup', fileInput.files[0]);

    fetch('/api/restore', {
        method: 'POST',
        body: formData
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert(data.message + '\n\nRestored: ' + data.restored.join(', '));
            restoreModal.hide();
            // Offer to reload
            if (confirm('Reload page to apply restored settings?')) {
                location.reload();
            }
        } else {
            alert('Restore failed: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(e => {
        alert('Restore error: ' + e);
    });
}

// Load backup info when Advanced tab is shown
document.querySelector('[data-bs-target="#tab-advanced"]').addEventListener('shown.bs.tab', loadBackupInfo);

// Test library paths - helps debug Docker mount issues
function testLibraryPaths() {
    const textarea = document.getElementById('library_paths');
    const paths = textarea.value.split('\n').map(p => p.trim()).filter(p => p);
    const resultsDiv = document.getElementById('path-test-results');

    if (paths.length === 0) {
        resultsDiv.innerHTML = '<div class="alert alert-warning py-2">No paths to test. Enter at least one path above.</div>';
        resultsDiv.style.display = 'block';
        return;
    }

    resultsDiv.innerHTML = '<div class="text-muted"><i class="bi bi-hourglass-split"></i> Testing paths...</div>';
    resultsDiv.style.display = 'block';

    let html = '';
    let completed = 0;

    paths.forEach(path => {
        fetch('/api/check_path', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({path: path})
        })
        .then(r => r.json())
        .then(data => {
            completed++;

            if (data.success) {
                html += `<div class="alert alert-success py-2 mb-2">
                    <i class="bi bi-check-circle"></i> <strong>${escapeHtml(path)}</strong> - OK
                    <br><small>${data.total_entries || 0} items found</small>
                    ${data.contents && data.contents.length > 0 ?
                        `<br><small class="text-muted">First items: ${data.contents.slice(0,5).map(c => c.name).join(', ')}${data.total_entries > 5 ? '...' : ''}</small>` : ''}
                </div>`;
            } else {
                html += `<div class="alert alert-danger py-2 mb-2">
                    <i class="bi bi-x-circle"></i> <strong>${escapeHtml(path)}</strong> - NOT ACCESSIBLE
                    <br><small>${escapeHtml(data.error || 'Unknown error')}</small>
                    ${data.suggestion ? `<br><pre class="mt-2 p-2 bg-dark text-light small" style="white-space: pre-wrap;">${escapeHtml(data.suggestion)}</pre>` : ''}
                    ${data.available_mounts ? `<br><small class="text-info">Try one of these instead: ${data.available_mounts.join(', ')}</small>` : ''}
                </div>`;
            }

            if (completed === paths.length) {
                resultsDiv.innerHTML = html;
            }
        })
        .catch(e => {
            completed++;
            html += `<div class="alert alert-danger py-2 mb-2">
                <i class="bi bi-x-circle"></i> <strong>${escapeHtml(path)}</strong> - Error: ${e}
            </div>`;
            if (completed === paths.length) {
                resultsDiv.innerHTML = html;
            }
        });
    });
}
</script>
{% endblock %}
